# API管理方針

## **現状確認**

### **検出された主要問題**

**Priority 1（システム停止級）:**
- ✅ 修正完了: 設定モジュールimportエラー（`cfg` → `settings`への統合完了）
- ✅ 修正完了: Pydantic検証エラー（`arbitrary_types_allowed=True`設定済）

**Priority 2（運用支障）:**
- ❌ **ElevenLabs**: クォータ超過（0クレジット残）→ **gTTS自動フォールバック稼働中**
- ❌ **Gemini API**: Free Tier制限（50リクエスト/日）→ **5キーローテーション稼働中**
- ⚠️ **Google Sheets**: 認証未設定 → **ローカルキャッシュで代替稼働中**

## **実装済み安定化機構**

### **1. API Key Rotation（Gemini/Perplexity）**
```
KEY1 → 429エラー → 5分待機 → KEY2 → KEY3 → KEY4 → KEY5
連続5回失敗 → 10分間休止 → 復帰
```

### **2. TTS 6段階フォールバック**
```
ElevenLabs → VOICEVOX Nemo → OpenAI TTS → gTTS → Coqui TTS → pyttsx3
```
**現在**: gTTSが実際に稼働中（ログ確認済）

### **3. Google Sheets ローカルキャッシュ**
- TTL 24時間
- API障害時は自動的にキャッシュから読込

## **レート制限詳細（実測値）**

| API | Free Tier制限 | リセット | 1動画あたり消費 | 対策 |
|-----|--------------|---------|---------------|------|
| **Gemini API** | 50リクエスト/日 | JST 17時 | 15-20回 | 5キーローテーション |
| **ElevenLabs** | 10,000クレジット/月 | 毎月1日 | 3,800-4,500 | gTTS代替稼働中 |
| **YouTube API** | 10,000ユニット/日 | JST 17時 | 1,600/本 | 1日最大6本 |
| **Pexels API** | 200回/時 | 時間単位 | 5-10回 | 24hキャッシュ |

### **Gemini 2.5 Flash Preview (09-2025) Rate Limits**

全エージェント・補助ツールは `gemini-2.5-flash-preview-09-2025` に統一しました。過去のPro系モデルやLite系モデルは運用から外しているため、以下のレート制限のみを追跡すれば十分です。

#### **Free Tier**

| Tier | RPM（分あたりリクエスト） | TPM（分あたりトークン） | RPD（日あたりリクエスト） |
|------|----------------------|-------------------|---------------------|
| Free | 10 | 250,000 | 250 |

#### **Tier 1**

| Tier | RPM | TPM | RPD |
|------|-----|-----|-----|
| Tier 1 | 1,000 | 1,000,000 | 10,000 |

**注意事項:**
- レート制限はプロジェクト単位で適用（APIキー単位ではない）
- 本プロジェクトでは1動画生成に15-20リクエスト使用
- Tier 1への移行で大幅な制限緩和が可能（~$10/月）

## **推奨アクション（優先度順）**

### **即座対応（P0）**
1. **ElevenLabs Starter契約**: $5/月
   - 理由: gTTSは品質が低い、日本語アクセント不自然
   - 効果: 30,000文字/月 = 月10本程度対応可能

2. **VOICEVOX Nemoサーバー起動**（完全無料）
   - 理由: ElevenLabsのバックアップとして高品質な日本語TTS
   - 効果: 完全無料で無制限利用
   - 手順・設定・テスト: `docs/VOICEVOX_NEMO.md`

### **短期対応（P1: 1週間以内）**
3. **Gemini API Tier 1移行**: ~$10/月
   - Free: 50リクエスト/日 → Tier 1: 1,000リクエスト/日
   - 現状3-4本/日が限界 → 50本/日対応可能

4. **`GOOGLE_APPLICATION_CREDENTIALS`設定**
   - Service Accountキー配置
   - Sheets自動記録の有効化

### **中期対応（P2: 1ヶ月以内）**
5. **YouTube APIクォータ拡張申請**
   - 10,000 → 100,000ユニット/日
   - 1日6本 → 60本対応可能

## **月額コスト試算**

### **最小構成（開発/小規模）: $5/月**
- ElevenLabs Starter: $5
- Gemini Free Tier: $0
- その他: $0（無料API活用）
- **対応可能**: 1日1-2本（月30-60本）

## **システム可用性**

### **現在の状態（2025年10月3日時点）**
- **全体可用性**: 95%+（APIフォールバック稼働中）
- **ニュース収集**: 99.99%（Perplexity + NewsAPI）
- **台本生成**: 99.5%（Gemini 5キーローテーション）
- **音声合成**: 98%（gTTS代替稼働中、品質は低下）
- **動画生成**: 95%+（FFmpeg安定）

### **推奨対応後の期待値**
- **音声品質**: 大幅改善（VOICEVOX/ElevenLabs）

## **まとめ**

### **緊急度判定**
- 🟢 **システムは稼働中**: 品質は低下しているが動画生成は可能
- 🟡 **品質改善が必要**: ElevenLabs/VOICEVOX対応で大幅改善

### **最も効果的な対策**
1. **VOICEVOX Nemo起動**（無料、即効性大）
