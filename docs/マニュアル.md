# マニュアル

## 1. システムの目的と用語
- このシステムは`YouTubeWorkflow`が11個の`WorkflowStep`を連携させ、ニュース収集からYouTube公開までの制作フローを自動化するために設計されている。【F:app/main.py†L31-L102】
- `WorkflowStep`は各工程の振る舞いを定義する抽象クラスであり、`WorkflowContext`が工程間で共有するデータの保管庫、`StepResult`が成果報告書の役割を担う。【F:app/workflow/base.py†L11-L90】

## 2. 初期セットアップ
1. プロジェクトのルートで依存関係をインストールし、`.env`にAPIキーなどの秘密情報を配置する (リポジトリでは`.env`はGit管理外を想定)。
2. `config.yaml`を環境に合わせて調整する。設定は`cfg`として読み込まれ、全ステップで参照されるため、API設定やメディアオプションをここで一元管理できる。【F:app/main.py†L25-L38】
3. CrewAIを利用する場合はGoogle Sheetsのプロンプト管理が有効な状態にあることを確認する。プロンプトは自動で読み込まれ、使用履歴も記録される。【F:app/workflow/steps.py†L46-L65】

## 3. 典型的な実行手順
1. **フルワークフロー実行**: `uv run python3 -m app.main daily`で日次モードの自動制作を開始する。【F:README.md†L30-L33】
2. **CrewAIフローの検証**: 台本生成のみ確認したい場合は`uv run python3 test_crewai_flow.py`を実行する。【F:README.md†L37-L38】
3. **品質確認**: ワークフロー完了後、`QualityAssuranceStep`が生成するレポート(`qa_report_path`)を確認すると自動判定の詳細が把握できる。【F:app/workflow/steps.py†L557-L633】
4. **成果物の場所**: 動画ステップは音声・字幕・台本・サムネイルをタイムスタンプ付きディレクトリに整理するため、アーカイブ先から一式を取得できる。【F:app/workflow/steps.py†L503-L548】

## 4. トラブルシューティングのヒント
- ニュース収集が失敗した場合はGoogle Sheets上のプロンプトや外部APIキーを見直す。ステップはニュースが0件だと即時失敗を返す設計である。【F:app/workflow/steps.py†L52-L69】
- 台本生成でエラーが出た際はスクリプト構造検証ログ(最大5件の警告)と生成された`script_path`を確認する。CrewAIが失敗した場合でもレガシーフローへフォールバックできる。【F:app/workflow/steps.py†L112-L246】
- 品質ゲートで差し戻された場合は`qa_retry_request`に記録された`start_step`と`reason`を参照し、指定ステップから再度実行する。【F:app/workflow/steps.py†L585-L624】【F:app/main.py†L134-L174】

## 5. 保守運用のベストプラクティス
- 変更を加えた際は`pytest tests/unit -v`でユニットテストを実行し、`uv run ruff check .`で静的解析を通す。【F:README.md†L40-L45】
- 実行ログは`YouTubeWorkflow`が保持する`_log_session`を通じて記録されるため、障害解析時はログシステムと連携して経緯を追跡する。【F:app/main.py†L16-L199】
- DriveやYouTubeへのアップロード結果は`StepResult`の`warning`フィールドにも格納される。公開に問題がないか最終確認する際に参照すると良い。【F:app/workflow/steps.py†L780-L865】

