# 技術報告書

## 1. システム概要
- パイプラインはStrategyパターンで分割された`WorkflowStep`群と、それらをオーケストレートする`YouTubeWorkflow`から構成される。これにより個々の工程を独立してテスト・差し替えできるようにしている。【F:app/main.py†L59-L138】【F:app/workflow/base.py†L48-L90】
- 各工程は`StepResult`で成果物と状態を返却し、`WorkflowContext`を介して次工程へ情報を引き継ぐ設計である。【F:app/workflow/base.py†L11-L45】

## 2. 主要な技術的判断
### 2.1 CrewAI統合と台本品質管理
- 台本生成ステップはCrewAIフロー(`create_wow_script_crew`)による高品質生成とレガシー三段階チェックのフォールバックを持ち、どちらもスクリプト構造検証`ensure_dialogue_structure`を必須としている。【F:app/workflow/steps.py†L95-L246】
- 検証結果は警告を最大5件ログ出力し、標準化済みテキストをファイルへ保存するため、後続のTTSや字幕処理が安定する。【F:app/workflow/steps.py†L126-L186】

### 2.2 統一ビジュアル生成
- `GenerateVisualDesignStep`はニュース内容と台本から抽出した感情トーンを基に`create_unified_design`を呼び出し、必要に応じてデフォルトテーマへフォールバックする。【F:app/workflow/steps.py†L270-L334】
- 生成したデザインオブジェクトはサムネイルと動画生成ステップ双方で利用されるようディクショナリ化されており、視覚的統一感を担保する。【F:app/workflow/steps.py†L320-L334】

### 2.3 メディア品質ゲートとリトライ機構
- `QualityAssuranceStep`は`MediaQAPipeline`に台本・音声・字幕・動画を渡して解析し、ブロック対象が発生した場合は`qa_retry_request`に再開地点と理由を格納する。【F:app/workflow/steps.py†L557-L633】
- ワークフロー側はこの指示を読み取り、`RETRY_CLEANUP_MAP`に基づいて不要な状態を削除した上で指定ステップから再実行する。これにより再試行が副作用なく行える。【F:app/main.py†L66-L174】

## 3. データフローとファイル処理
- 音声合成から字幕整合までの区間では、台本の再正規化→TTS→STT→SRT生成という直列フローを採用し、失敗時は早期に`_failure`を返して後続処理を止めるガードを備える。【F:app/workflow/steps.py†L338-L469】
- 動画生成後は`FileArchivalManager`が音声・字幕・台本・サムネイルをタイムスタンプ付きディレクトリへ整理し、アーカイブ先パスにコンテキストを更新することで後続アップロードが安定する。【F:app/workflow/steps.py†L503-L548】

## 4. 外部サービス連携
- Google Sheetsからプロンプトを取得し、使用履歴を記録することでプロンプト管理のトレーサビリティを確保している。【F:app/workflow/steps.py†L46-L79】
- Google Driveアップロードでは動画・サムネイル・字幕・メタデータをまとめて送信し、エラー内容を`warning`として保持するため、失敗してもログから原因を追跡できる。【F:app/workflow/steps.py†L761-L803】
- YouTubeアップロード結果には動画IDとURLが含まれ、コンテキスト経由で`metadata_storage`へ統合されるため、公開済みコンテンツの分析が可能になる。【F:app/workflow/steps.py†L804-L865】【F:app/main.py†L181-L199】

## 5. リスクと改善提案
- ニュース収集・台本生成など外部API依存の工程は空データを返すと即座に失敗するため、今後は代替ソースのフェイルオーバー実装が望ましい。【F:app/workflow/steps.py†L52-L125】
- メディア品質ゲートがブロックした際に許容リトライ回数を超えるとワークフロー全体が停止するため、QA項目ごとの重み付けや部分的な自動修正機能の追加が検討事項となる。【F:app/workflow/steps.py†L585-L624】【F:app/main.py†L127-L174】

