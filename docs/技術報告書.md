# 技術報告書

## 1. システム概要
- パイプラインはStrategyパターンで分割された`WorkflowStep`群と、それらをオーケストレートする`YouTubeWorkflow`から構成される。これにより個々の工程を独立してテスト・差し替えできるようにしている。【F:app/main.py†L59-L138】【F:app/workflow/base.py†L48-L90】
- 各工程は`StepResult`で成果物と状態を返却し、`WorkflowContext`を介して次工程へ情報を引き継ぐ設計である。【F:app/workflow/base.py†L11-L45】

## 2. 主要な技術的判断
### 2.1 CrewAI統合と台本品質管理
- 台本生成ステップはCrewAIフロー(`create_wow_script_crew`)による高品質生成とレガシー三段階チェックのフォールバックを持ち、どちらもスクリプト構造検証`ensure_dialogue_structure`を必須としている。【F:app/workflow/steps.py†L95-L246】
- 検証結果は警告を最大5件ログ出力し、標準化済みテキストをファイルへ保存するため、後続のTTSや字幕処理が安定する。【F:app/workflow/steps.py†L126-L186】

### 2.2 統一ビジュアル生成
- `GenerateVisualDesignStep`はニュース内容と台本から抽出した感情トーンを基に`create_unified_design`を呼び出し、必要に応じてデフォルトテーマへフォールバックする。【F:app/workflow/steps.py†L270-L334】
- 生成したデザインオブジェクトはサムネイルと動画生成ステップ双方で利用されるようディクショナリ化されており、視覚的統一感を担保する。【F:app/workflow/steps.py†L320-L334】

### 2.3 メディア品質レポートと改善サイクル
- `QualityAssuranceStep`は`MediaQAPipeline`に台本・音声・字幕・動画を渡して解析し、結果を`WorkflowContext`とJSONレポートに記録する。既定では`config.media_quality.gating.enforce=false`のためブロックせず手動改善の参考情報として扱うが、設定を戻せば自動ブロック運用も可能。【F:app/workflow/steps.py†L585-L633】【F:config.yaml†L59-L94】
- レポートはDiscord通知やアーカイブと合わせて確認し、必要に応じて該当ステップのみを手動で再実行する運用を想定している。【F:app/main.py†L104-L205】

## 3. データフローとファイル処理
- 音声合成から字幕整合までの区間では、台本の再正規化→TTS→STT→SRT生成という直列フローを採用し、失敗時は早期に`_failure`を返して後続処理を止めるガードを備える。【F:app/workflow/steps.py†L338-L469】
- 動画生成後は`FileArchivalManager`が音声・字幕・台本・サムネイルをタイムスタンプ付きディレクトリへ整理し、アーカイブ先パスにコンテキストを更新することで後続アップロードが安定する。【F:app/workflow/steps.py†L503-L548】

## 4. 外部サービス連携
- Google Sheetsからプロンプトを取得し、使用履歴を記録することでプロンプト管理のトレーサビリティを確保している。【F:app/workflow/steps.py†L46-L79】
- Google Driveアップロードでは動画・サムネイル・字幕・メタデータをまとめて送信し、エラー内容を`warning`として保持するため、失敗してもログから原因を追跡できる。【F:app/workflow/steps.py†L761-L803】
- YouTubeアップロード結果には動画IDとURLが含まれ、コンテキスト経由で`metadata_storage`へ統合されるため、公開済みコンテンツの分析が可能になる。【F:app/workflow/steps.py†L804-L865】【F:app/main.py†L181-L199】

## 5. リスクと改善提案
- ニュース収集・台本生成など外部API依存の工程は空データを返すと即座に失敗するため、今後は代替ソースのフェイルオーバー実装が望ましい。【F:app/workflow/steps.py†L52-L125】
- QAレポートは既定設定（`gating.enforce=false`）ではブロックを伴わないため、今後は指摘内容から自動補正を行うモジュールや、緊急性に応じた通知レベルの最適化が検討事項となる。必要であれば設定を`true`に戻して自動ブロック運用へ切り替えられる。【F:app/workflow/steps.py†L585-L624】【F:app/main.py†L127-L174】【F:config.yaml†L59-L94】

