# 詳細設計仕様書

## 0. 状況整理
- 本システムは`YouTubeWorkflow`クラスがStrategyパターンで定義された各`WorkflowStep`を順に実行し、ニュース取得から動画公開までの11工程を自動化するYouTube制作パイプラインである。【F:app/main.py†L31-L102】
- 各ステップは`WorkflowStep`抽象基底クラスを継承し、共有コンテキスト`WorkflowContext`とステップ結果`StepResult`を介して疎結合に連携する構造を採用している。【F:app/workflow/base.py†L11-L90】

## 1. 中央オーケストレーション
| 要素 | 定義 (コード上の役割) | 直観的説明 |
|------|-----------------------|------------|
| `YouTubeWorkflow` | ステップ配列とリトライ戦略を保持し、コンテキストを生成して実行を制御するオーケストレータ。【F:app/main.py†L59-L174】 | プロジェクトマネージャーのように各担当者(ステップ)へ順番に仕事を依頼し、結果を整理しながら問題が起きたら再挑戦を判断する司令塔。 |
| `RETRY_CLEANUP_MAP` | リトライ時にクリアすべきコンテキストキーをステップごとに定義するマッピング。【F:app/main.py†L66-L78】 | やり直す際に片付ける資料の一覧表。失敗した工程の中途半端な成果物を掃除して次の試行をクリーンにする。 |
| `WorkflowContext` | 共有状態・生成物リストを管理するデータクラス。【F:app/workflow/base.py†L26-L45】 | 旅のしおりのように各工程で得た情報やファイルパスを保管し、次の担当者が参照できるようにする。 |
| `StepResult` | 成功可否・生成データ・ファイル一覧をまとめるレスポンスオブジェクト。【F:app/workflow/base.py†L11-L23】 | 各担当者が提出する成果報告書。成功か失敗か、どんな資料を添付したかを明示する。 |

## 2. ワークフローコンポーネント一覧
| ステップ | 定義された振る舞い | 直観的説明 |
|----------|---------------------|------------|
| ニュース収集 (`CollectNewsStep`) | Google Sheetsからのプロンプト取得を含めニュース抽出を実行し、結果をコンテキストへ保存する。【F:app/workflow/steps.py†L36-L92】 | リサーチ担当がその日の注目経済ニュースを調べ、後続の制作チームに共有する。 |
| 台本生成 (`GenerateScriptStep`) | CrewAIまたはレガシー生成を呼び出し、構造検証とファイル保存を行う。【F:app/workflow/steps.py†L95-L246】 | 台本作家がニュースを基に会話形式の脚本を作り、読みやすさを校正して全員がアクセスできる場所に置く。 |
| 統一ビジュアル設計 (`GenerateVisualDesignStep`) | ニュースと台本からスタイルを算出し、デフォルトフォールバックも備える。【F:app/workflow/steps.py†L270-L335】 | アートディレクターが動画とサムネイルのテーマカラーや雰囲気を決め、制作物に一貫性を持たせる。 |
| メタデータ生成 (`GenerateMetadataStep`) | タイトル・説明などを作成し、保存・フォールバック処理を実装する。【F:app/workflow/steps.py†L636-L701】 | 編集担当がYouTube用のタイトルや概要文を作り、問題があれば汎用テンプレートに切り替える。 |
| サムネイル生成 (`GenerateThumbnailStep`) | ビジュアル設計スタイルを参照して画像を生成し、失敗時は警告を残す。【F:app/workflow/steps.py†L704-L759】 | デザイナーが決めたテーマを基にサムネイルを描き、うまくできなければ注意書きを添える。 |
| 音声合成 (`SynthesizeAudioStep`) | 台本の再正規化とTTS生成を実行し、音声ファイルを記録する。【F:app/workflow/steps.py†L338-L390】 | ナレーターの代わりに合成音声を収録し、台本の不整合があれば修正してから読み上げる。 |
| 音声書き起こし (`TranscribeAudioStep`) | WhisperベースのSTTで語彙列を抽出し、コンテキストに格納する。【F:app/workflow/steps.py†L393-L425】 | 収録した音声を聞き取り、どの単語がいつ話されたかを文字にして記録する。 |
| 字幕整合 (`AlignSubtitlesStep`) | 台本とSTT結果を同期させ、SRTを出力する。【F:app/workflow/steps.py†L427-L469】 | 台本の行と実際の発話タイミングを合わせて、視聴者向け字幕ファイルを作る。 |
| 動画生成 (`GenerateVideoStep`) | 音声・字幕・ニュース情報を統合し、成果物をアーカイブへ整理する。【F:app/workflow/steps.py†L471-L555】 | 映像編集者が音声と字幕を合成し、完成ファイルを所定のフォルダへまとめて保管する。 |
| 品質保証 (`QualityAssuranceStep`) | `MediaQAPipeline`で品質チェックを行い、ブロック時はリトライ指示を記録する。【F:app/workflow/steps.py†L557-L633】 | 品質管理担当が動画を検査し、基準に達しない場合はどこからやり直すかを明示して差し戻す。 |
| Driveアップロード (`UploadToDriveStep`) | 生成物一式をDriveへ送信し、警告も結果に含める。【F:app/workflow/steps.py†L761-L803】 | バックアップ担当が制作物を社内共有フォルダへアップロードし、問題があればメモを残す。 |
| YouTubeアップロード (`UploadToYouTubeStep`) | 公開処理を行い、動画ID・URLを保存する。【F:app/workflow/steps.py†L804-L865】 | 配信担当がYouTubeに投稿し、出来上がったURLをチームへ共有する。 |
| AIレビュー (`ReviewVideoStep`) | 生成動画を解析し、スクリーンショットや要約をコンテキストに格納する。【F:app/workflow/steps.py†L867-L942】 | 品質改善のためにAIレビューアーが動画を確認し、気付きとハイライト画像を添える。 |

## 3. コンテキストとデータ管理
- 各ステップは`context.set`でキーを登録し、後続ステップが`context.get`で取得することでバッテリーラインのような情報受け渡しを実現している。【F:app/workflow/base.py†L35-L45】【F:app/workflow/steps.py†L58-L65】【F:app/workflow/steps.py†L146-L158】
- `YouTubeWorkflow`はステップが生成したファイルパスを`context.add_files`で記録し、成功時にまとめてメタデータ更新へ活用する。【F:app/main.py†L134-L199】【F:app/workflow/base.py†L43-L45】

## 4. 生成物とファイル整理
- 動画生成ステップは`FileArchivalManager`で音声・字幕・台本・サムネイルをタイムスタンプ付きディレクトリにまとめ、アーカイブされたパスをコンテキストへ再設定する。【F:app/workflow/steps.py†L503-L548】
- Drive/YouTubeアップロードではそれぞれのAPIレスポンスを`StepResult`に含め、成功・警告・失敗を明示することで追跡可能な監査ログを構成する。【F:app/workflow/steps.py†L780-L865】

## 5. 品質保証とリトライ戦略
- 品質ゲートが有効な場合、`MediaQAPipeline`は台本・音声・字幕・動画を横断的に評価し、ブロッキング判定で`qa_retry_request`に再開ステップと理由を格納する。【F:app/workflow/steps.py†L557-L633】
- ワークフロー本体はQA失敗時に`_resolve_step_index`で指定ステップに戻り、再試行前に不要な状態を`RETRY_CLEANUP_MAP`に従ってクリアすることで再実行を安定化させる。【F:app/main.py†L134-L174】

